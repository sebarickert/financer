# This is a basic workflow to help you get started with Actions

name: Lint and build app

on:
  push:
    branches:
      - production
  pull_request:
    branches:
      - production
  workflow_dispatch:

concurrency:
  group: ci-build_${{ github.ref }}
  cancel-in-progress: true

jobs:
  install:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: "16.14.0"
          cache: "npm"
      - uses: actions/cache@v2
        id: modules-cache
        with:
          path: "**/node_modules"
          key: ${{ runner.os }}-modules-${{ hashFiles('./package-lock.json') }}
      - name: Copy package-lock for cypress action
        run: cp package-lock.json ./packages/cypress/package-lock.json
      - name: Install dependencies
        if: steps.modules-cache.outputs.cache-hit != 'true'
        uses: cypress-io/github-action@v2
        with:
          runTests: false
          working-directory: packages/cypress
          install-command: npm ci --prefix ../../

  lint-and-unit-test:
    runs-on: ubuntu-latest
    needs: install
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: "16.14.0"
      - uses: actions/cache@v2
        with:
          path: "**/node_modules"
          key: ${{ runner.os }}-modules-${{ hashFiles('./package-lock.json') }}
      - name: Run frontend lint
        run: npm -w frontend run lint
      - name: Run backend lint
        run: npm -w backend run lint
      - name: Run frontend tests
        run: npm -w frontend run test
      - name: Run backend tests
        run: npm -w backend run test

  build:
    runs-on: ubuntu-latest
    needs: install
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: "16.14.0"
      - uses: actions/cache@v2
        with:
          path: "**/node_modules"
          key: ${{ runner.os }}-modules-${{ hashFiles('./package-lock.json') }}
      - uses: actions/cache@v2
        id: build-cache
        with:
          path: "./build"
          key: ${{ runner.os }}-build-${{ hashFiles('./package-lock.json') }}-${{ hashFiles('./packages/backend/**') }}-${{ hashFiles('./packages/frontend/**') }}-${{ hashFiles('./packages/types/**') }}
      - name: Build app
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: npm run build

  run-cypress-test:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      fail-fast: false
      matrix:
        specs:
          [
            "Account",
            "Expenses",
            "Incomes",
            "TransactionCategories",
            "Transfer",
          ]
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: "16.14.0"
      - uses: actions/cache@v2
        with:
          path: "**/node_modules"
          key: ${{ runner.os }}-modules-${{ hashFiles('./package-lock.json') }}
      - uses: actions/cache@v2
        with:
          path: "./build"
          key: ${{ runner.os }}-build-${{ hashFiles('./packages/backend/**') }}-${{ hashFiles('./packages/frontend/**') }}-${{ hashFiles('./packages/types/**') }}
      - name: Copy package-lock for cypress action
        run: cp package-lock.json ./packages/cypress/package-lock.json
      - name: Run cypress
        uses: cypress-io/github-action@v2
        with:
          spec: cypress/integration/${{ matrix.specs }}/**
          install-command: echo "npm already installed, skipping"
          working-directory: packages/cypress
          start: npm run start:ci --prefix ../../
          wait-on: "http://localhost:3000"
          wait-on-timeout: 60
          headless: true
        env:
          NODE_ENV: "test"
          PORT: "3000"
